<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.meta.stock.product.mapper.ProductionRequestMapper">
    <resultMap id="ProductResultMap" type="com.meta.stock.product.dto.ProductDTO">
        <id property="productId" column="PRODUCT_ID"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="lotsId" column="LOTS_ID"/>
    </resultMap>

    <!-- OrderDto 매핑 + ProductDTO 포함 -->
    <resultMap id="ProductRequestMap" type="com.meta.stock.product.dto.ProductRequestDto">
        <id property="prId" column="PR_ID"/>
        <result property="managementEmployee" column="MANAGEMENT_EMPLOYEE"/>
        <result property="productionEmployee" column="PRODUCTION_EMPLOYEEE"/>
        <result property="serialCode" column="SERIAL_CODE"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="toCompany" column="TO_COMPANY"/>
        <result property="targetQty" column="TARGET_QTY"/>
        <result property="plannedQty" column="PLANNED_QTY"/>
        <result property="completedQty" column="COMPLETED_QTY"/>
        <result property="inStockQty" column="in_stock_qty"/>
        <result property="unit" column="UNIT"/>
        <result property="requestDate" column="REQUEST_DATE"/>
        <result property="productionStartDate" column="PRODUCTION_START_DATE"/>
        <result property="deadline" column="DEADLINE"/>
        <result property="endDate" column="END_DATE"/>
        <result property="note" column="NOTE"/>

        <!-- <association property="productDto" javaType="com.meta.stock.product.dto.ProductDTO" resultMap="ProductResultMap"/> -->
    </resultMap>

    <select id="findAllProductionRequests" resultMap="ProductRequestMap">
        SELECT
        pr.pr_id,
        pr.serial_code,
        fp.name as product_name,
        pr.to_company,
        pr.target_qty,
        pr.planned_qty,
        pr.completed_qty,
        pr.unit,
        pr.request_date,
        pr.deadline,
        pr.production_start_date,
        pr.end_date,
        pr.note
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
    </select>

    <!-- 진행중인 주문 조회 (JOIN)-->
    <select id="findOngoingRequestsWithPaging" resultMap="ProductRequestMap">
        SELECT
        pr.pr_id,
        pr.serial_code,
        fp.name as product_name,
        pr.to_company,
        pr.target_qty,
        NVL(pr.planned_qty, 0) as planned_qty,
        NVL(pr.completed_qty, 0) as completed_qty,
        pr.unit,
        TO_CHAR(pr.request_date, 'YYYY-MM-DD') as request_date,
        TO_CHAR(pr.deadline, 'YYYY-MM-DD') as deadline,
        TO_CHAR(pr.production_start_date, 'YYYY-MM-DD') as production_start_date,
        TO_CHAR(pr.end_date, 'YYYY-MM-DD') as end_date,
        pr.note,
        NVL(stock.in_stock_qty, 0) as in_stock_qty
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        LEFT JOIN (
        SELECT
        fp2.serial_code,
        SUM(l.qty) as in_stock_qty
        FROM Products p
        INNER JOIN Lots l ON p.lots_id = l.lot_id
        INNER JOIN Fixed_Product fp2 ON p.product_name = fp2.name
        WHERE l.qty > 0
        GROUP BY fp2.serial_code
        ) stock ON pr.serial_code = stock.serial_code
        WHERE pr.end_date IS NULL
        <if test="keyword != null and keyword != ''">
            AND fp.name LIKE '%' || #{keyword} || '%'
        </if>
        ORDER BY
        <choose>
            <when test="sortBy == 'requestDate'">pr.request_date</when>
            <when test="sortBy == 'deadline'">pr.deadline</when>
            <when test="sortBy == 'productName'">fp.name</when>
            <otherwise>pr.request_date</otherwise>
        </choose>
        <choose>
            <when test="sortDir == 'DESC'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>
        OFFSET #{offset} ROWS
        FETCH NEXT #{limit} ROWS ONLY
    </select>


    <!-- 전체 주문 조회 -->
    <select id="countOngoingRequests" resultType="long">
        SELECT COUNT(*)
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        WHERE pr.end_date IS NULL
        <if test="keyword != null and keyword != ''">
            AND fp.name LIKE '%' || #{keyword} || '%'
        </if>
    </select>

    <select id="findAllRequestsWithPaging" resultMap="ProductRequestMap">
        SELECT
        pr.pr_id,
        pr.management_employee,
        pr.production_employee,
        fp.name as product_name,
        pr.to_company,
        pr.target_qty,
        pr.unit,
        TO_CHAR(pr.deadline, 'YYYY-MM-DD') as deadline,
        TO_CHAR(pr.production_start_date, 'YYYY-MM-DD') as production_start_date,
        TO_CHAR(pr.request_date, 'YYYY-MM-DD') as request_date,
        TO_CHAR(pr.end_date, 'YYYY-MM-DD') as end_date
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (fp.name LIKE '%' || #{keyword} || '%'
            OR pr.to_company LIKE '%' || #{keyword} || '%')
        </if>
        ORDER BY
        <choose>
            <when test="sortBy == 'prId'">pr.pr_id</when>
            <when test="sortBy == 'managementEmployee'">pr.management_employee</when>
            <when test="sortBy == 'productName'">fp.name</when>
            <when test="sortBy == 'toCompany'">pr.to_company</when>
            <when test="sortBy == 'targetQty'">pr.target_qty</when>
            <when test="sortBy == 'deadline'">pr.deadline</when>
            <when test="sortBy == 'endDate'">pr.end_date</when>
            <otherwise>pr.pr_id</otherwise>
        </choose>
        <choose>
            <when test="sortDir == 'DESC'">DESC</when>
            <otherwise>ASC</otherwise>
        </choose>
        OFFSET #{offset} ROWS
        FETCH NEXT #{limit} ROWS ONLY
    </select>

    <select id="countAllRequests" resultType="long">
        SELECT COUNT(*)
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        WHERE 1=1
        <if test="keyword != null and keyword != ''">
            AND (fp.name LIKE '%' || #{keyword} || '%'
            OR pr.to_company LIKE '%' || #{keyword} || '%')
        </if>
    </select>

    <select id="findProductRequestById" resultMap="ProductRequestMap">
        SELECT
        pr.pr_id,
        pr.management_employee,
        pr.production_employee,
        pr.serial_code,
        fp.name as product_name,
        pr.to_company,
        pr.target_qty,
        pr.planned_qty,
        pr.completed_qty,
        pr.unit,
        TO_CHAR(pr.request_date, 'YYYY-MM-DD') as request_date,
        TO_CHAR(pr.production_start_date, 'YYYY-MM-DD') as production_start_date,
        TO_CHAR(pr.deadline, 'YYYY-MM-DD') as deadline,
        TO_CHAR(pr.end_date, 'YYYY-MM-DD') as end_date,
        pr.note
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        WHERE pr.pr_id = #{prId}
    </select>

    <!-- 생산 시작일 업데이트 (수주) -->
    <update id="updateProductionStartDate">
        UPDATE Production_Request
        SET
        PRODUCTION_EMPLOYEE = #{employeeId},
        PLANNED_QTY = ${plannedQty},
        production_start_date = SYSDATE
        WHERE pr_id = #{prId}
    </update>

    <!-- 종료일 업데이트 (출하 완료) -->
    <update id="updateEndDate">
        UPDATE Production_Request
        SET end_date = SYSDATE
        WHERE pr_id = #{prId}
    </update>

    <select id="getOngoingRequestsCount">
        SELECT count(*)
        FROM Production_Request pr
        LEFT JOIN Fixed_Product fp ON pr.serial_code = fp.serial_code
        WHERE pr.end_date IS NULL
    </select>

    <select id="countCompleted" resultType="int">
        SELECT COUNT(*) FROM Production_Request WHERE end_date IS NOT NULL
    </select>

    <select id="countOverdue" resultType="int">
        <![CDATA[
        SELECT COUNT(*) FROM Production_Request
        WHERE end_date IS NULL
        AND deadline < SYSDATE
        ]]>
    </select>

    <select id="countOngoing" resultType="int">
        SELECT COUNT(*) FROM Production_Request
        WHERE production_start_date IS NOT NULL
        AND end_date IS NULL
        AND deadline >= SYSDATE
    </select>

    <select id="countPending" resultType="int">
        SELECT COUNT(*) FROM Production_Request WHERE production_start_date IS NULL
    </select>


</mapper>
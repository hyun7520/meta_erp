<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" th:href="@{/style/styles.css}">
</head>
<body>
<h1>사원 등록</h1>
<script>
    let idChecked = false; //중복체크 버튼을 클릭했는지
    let idAvailable = false;

    function checkId(){ <!--중복체크버튼-->
        idValue = document.getElementById('idInput').value;

        if(idValue == ''){
            alert("아이디를 입력하세요");
            return;
        }

        const idNum = parseInt(idValue);
        if (isNaN(idNum) || idNum < 1000) {
            alert("아이디 번호 시작은 1000부터 입니다.");
            const msgSpan = document.getElementById('idCheckResult');
            msgSpan.textContent = "아이디는 1000 이상이어야 합니다.";
            msgSpan.style.color = "red";
            return;
        }

        fetch("/checkId.mb?id="+encodeURIComponent(idValue))
            .then(response => response.text())
            .then(result => {
                    const msgSpan = document.getElementById('idCheckResult');
                    idChecked = true;
                    if(result == "duplicate"){
                        msgSpan.textContent = "이미 사용중인 아이디입니다.";
                        msgSpan.style.color = "red";
                        idAvailable = false;
                    } else{
                        msgSpan.textContent = "사용 가능한 아이디입니다.";
                        msgSpan.style.color = "green";
                        idAvailable = true;
                    }
                })
                .catch(error => {
                    console.log("에러 발생: ", error);
                });

    }//checkId

    <!--새로운 입력이 들어왔을때-->
    function resetIdCheck(){
        idChecked = false;
        idAvailable = false;
        const msgSpan = document.getElementById('idCheckResult');
        msgSpan.textContent = "아이디 중복체크 필수";
        msgSpan.style.color = "gray";
    }//resetIdCheck

    function validateForm(){
        if(!idChecked){
            alert("아이디 중복체크 필수");
            return false;
        }

        if(!idAvailable){
            alert("이미 사용중인 아이디입니다.");
            return false;
        }

        const emailPrefix = document.getElementById('emailPrefix').value.trim();
        const emailDomain = document.getElementById('emailDomain').value;
        const emailField = document.querySelector('input[name="email"]');

        if(emailPrefix === ''){
            alert("이메일 주소를 입력해주세요.");
            return false;
        }

        if (emailDomain === '') {
            alert("이메일 도메인을 선택해주세요.");
            return false;
        }

        emailField.value = emailPrefix + '@' + emailDomain;

        const department_id = document.getElementById('departmentSelect').value;
        const role_id = document.getElementById('roleSelect').value;

        if (department_id === '0') {
            alert("부서를 선택해주세요.");
            return false;
        }

        if (role_id === '0') {
            alert("직책을 선택해주세요.");
            return false;
        }

        return true;
    }
</script>

<form th:action="registerProc" th:object="${eDto}" method="post" onsubmit="return validateForm()">
    <table border="1">
        <tr>
            <td>아이디</td>
            <td>
                <input id="idInput" th:field="*{employee_id}" onkeyup="resetIdCheck()">
                <input type="button" value="중복체크" onclick="checkId()">
                <span id="idCheckResult"></span>
                <div th:if="${#fields.hasErrors('employee_id')}" th:errors="*{employee_id}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>이름</td>
            <td>
                <input th:field="*{name}">
                <div th:if="${#fields.hasErrors('name')}" th:errors="*{name}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>비번</td>
            <td>
                <input th:field="*{password}">
                <div th:if="${#fields.hasErrors('password')}" th:errors="*{password}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>이메일</td>
            <td>
                <input type="text" id="emailPrefix" placeholder="이메일 주소">
                <span>@</span>
                <select id="emailDomain">
                    <option value="">도메인 선택</option>
                    <option value="naver.com">naver.com</option>
                    <option value="gmail.com">gmail.com</option>
                    <option value="daum.net">daum.net</option>
                </select>
                <input type="hidden" th:field="*{email}">
                <div th:if="${#fields.hasErrors('email')}" th:errors="*{email}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>입사일</td>
            <td>
                <input type="date" th:field="*{hire_date}">
                <div th:if="${#fields.hasErrors('hire_date')}" th:errors="*{hire_date}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>부서</td>
            <td>
                <select id="departmentSelect" th:field="*{department_id}">
                    <option value="0">--- 부서 선택 ---</option>
                    <option value="100">경영</option>
                    <option value="200">생산</option>
                </select>
                <div th:if="${#fields.hasErrors('department_id')}" th:errors="*{department_id}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td>직책</td>
            <td>
                <select id="roleSelect" th:field="*{role_id}">
                    <option value="0">--- 직책 선택 ---</option>
                    <option value="1">사원</option>
                    <option value="2">감독관</option>
                </select>
                <div th:if="${#fields.hasErrors('role_id')}" th:errors="*{role_id}" class="err"></div>
            </td>
        </tr>

        <tr>
            <td colspan="2">
                <input type="submit" value="사원등록">
            </td>
        </tr>
    </table>
</form>
</body>
</html>
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문 상세</title>
</head>
<body>

<!-- ⭐ Fragment 정의: 모달에서 사용할 내용만 -->
<div th:fragment="content">

    <!-- 주문 기본 정보 -->
    <div style="background: #F8F9FA; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <h4 style="margin: 0; color: #374151;">주문 ID: <span th:text="${productRequest.prId}"></span></h4>
            <span th:switch="${productRequest.complete}">
                <span th:case="0" class="status-badge status-pending">미수주</span>
                <span th:case="1" class="status-badge status-approved">수주완료</span>
                <span th:case="2" class="status-badge status-rejected">완료</span>
            </span>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; font-size: 14px;">
            <div><strong>제품:</strong> <span th:text="${productRequest.productName}"></span></div>
            <div><strong>거래처:</strong> <span th:text="${productRequest.toCompany}"></span></div>
            <div><strong>주문수량:</strong> <span class="qty-unit" th:text="${productRequest.targetQty}"></span> <span th:text="${productRequest.unit}"></span></div>
            <div><strong>요청일:</strong> <span th:text="${productRequest.requestDate}"></span></div>
            <div><strong>납기:</strong> <span th:text="${productRequest.deadline}"></span></div>
            <div th:if="${productRequest.productionStartDate != null}">
                <strong>수주일:</strong> <span th:text="${productRequest.productionStartDate}"></span>
            </div>
            <div th:if="${productRequest.endDate != null}">
                <strong>완료일:</strong> <span th:text="${productRequest.endDate}"></span>
            </div>
        </div>
        <div th:if="${productRequest.note != null and productRequest.note != ''}" style="margin-top: 10px;">
            <strong>비고:</strong> <span th:text="${productRequest.note}"></span>
        </div>
    </div>

    <!-- 현재 완제품 재고 -->
    <div th:if="${productRequest.complete != 2}"
         th:style="'background: ' + ${currentProductStock >= productRequest.targetQty ? '#D1FAE5' : '#FEE2E2'} + '; padding: 15px; border-radius: 8px; margin-bottom: 20px;'">
        <h5 style="margin: 0 0 10px 0; color: #374151; font-size: 16px;">현재 완제품 재고</h5>
        <div>
            <strong th:text="${productRequest.productName}"></strong>:
            <span class="qty-unit" th:text="${currentProductStock}"></span>
            <span th:text="${productRequest.unit}"></span>
            <span th:if="${currentProductStock >= productRequest.targetQty}" class="status-badge status-approved">충분</span>
            <span th:unless="${currentProductStock >= productRequest.targetQty}" class="status-badge status-pending">
                부족 (필요: <span th:text="${productRequest.targetQty - currentProductStock}"></span>)
            </span>
        </div>
    </div>

    <!-- 원자재 정보 -->
    <div th:if="${(productRequest.complete == 0 or productRequest.complete == 1) and currentProductStock < productRequest.targetQty}"
         style="margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <h5 style="margin: 0; color: #374151; font-size: 16px;"
                th:text="${productRequest.complete == 0 ? '수주 시 필요한 원자재' : '남은 생산을 위한 원자재'}"></h5>
            <button onclick="requestMaterials()" class="btn btn-approve" style="font-size: 13px; padding: 8px 16px;">
                <i class="fas fa-shopping-cart"></i> 선택 재료 발주
            </button>
        </div>

        <p th:if="${productRequest.complete == 1}" style="color: #6B7280; margin-bottom: 10px; font-size: 13px;">
            남은 생산 필요량: <strong><span th:text="${productRequest.targetQty - currentProductStock}"></span> <span th:text="${productRequest.unit}"></span></strong>
        </p>

        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
            <thead>
            <tr style="background: #F3F4F6;">
                <th style="padding: 10px; text-align: center; border-bottom: 2px solid #E5E7EB; width: 50px;">
                    <input type="checkbox" id="selectAll" onclick="toggleSelectAll(this)" />
                </th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #E5E7EB;">재료명</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #E5E7EB;">필요수량</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #E5E7EB;">현재재고</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #E5E7EB;">부족수량</th>
                <th style="padding: 10px; text-align: left; border-bottom: 2px solid #E5E7EB;">상태</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="req : ${requirements}"
                th:style="'background: ' + ${req.sufficient ? '#D1FAE5' : '#FEE2E2'} + ';'">
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6; text-align: center;">
                    <input type="checkbox"
                           class="material-checkbox"
                           th:value="${req.materialName}"
                           th:attr="data-fmid=${req.fmId}, data-qty=${req.remainingQty}, data-unit=${req.unit}" />
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6;" th:text="${req.materialName}"></td>
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6;">
                    <span th:text="${req.requiredQty}"></span> <span th:text="${req.unit}"></span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6;">
                    <span th:text="${req.currentStock}"></span> <span th:text="${req.unit}"></span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6;">
                        <span th:if="${!req.sufficient}" style="color: #EF4444; font-weight: 600;">
                            <span th:text="${req.remainingQty}"></span> <span th:text="${req.unit}"></span>
                        </span>
                    <span th:if="${req.sufficient}" style="color: #10B981;">-</span>
                </td>
                <td style="padding: 10px; border-bottom: 1px solid #F3F4F6;">
                    <span th:if="${req.sufficient}" class="status-badge status-approved">충분</span>
                    <span th:unless="${req.sufficient}" class="status-badge status-pending">부족</span>
                </td>
            </tr>
            </tbody>
        </table>
    </div>

    <!-- 버튼 영역 -->
    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #E5E7EB; display: flex; gap: 10px; justify-content: flex-end;">
        <div th:switch="${productRequest.complete}">
            <!-- 미수주 상태 -->
            <div th:case="0">
                <button th:onclick="|acceptOrder(${productRequest.prId})|" class="btn btn-approve">
                    <i class="fas fa-check"></i> 주문 수주
                </button>
            </div>

            <!-- 수주 완료 상태 -->
            <div th:case="1">
                <button th:onclick="|shipOrder(${productRequest.prId})|"
                        class="btn btn-approve"
                        th:disabled="${currentProductStock < productRequest.targetQty}">
                    <i class="fas fa-shipping-fast"></i> 제품 출하
                </button>
                <span th:if="${currentProductStock < productRequest.targetQty}" style="color: #EF4444; font-size: 13px;">
                    ※ 재고 부족으로 출하 불가
                </span>
            </div>
        </div>

        <button onclick="closeModal()" class="btn btn-cancel">
            <i class="fas fa-times"></i> 닫기
        </button>
    </div>
</div>
</body>
</html>
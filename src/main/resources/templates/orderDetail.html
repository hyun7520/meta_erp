<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>주문 상세</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .table-success { background-color: #d4edda !important; }
        .table-danger { background-color: #f8d7da !important; }
    </style>
</head>
<body class="bg-light">
<div class="container mt-5">

    <!-- 주문 기본 정보 -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h4 class="mb-0">주문 ID: <span th:text="${order.pr_id}"></span></h4>
            <span th:switch="${order.complete}">
                <span th:case="0" class="badge bg-secondary fs-6">미수주</span>
                <span th:case="1" class="badge bg-warning fs-6">수주 완료</span>
                <span th:case="2" class="badge bg-success fs-6">완료</span>
            </span>
        </div>
        <div class="card-body">
            <p><strong>제품:</strong> <span th:text="${order.productDto.productName}"></span></p>
            <p><strong>거래처:</strong> <span th:text="${order.requestBy}"></span></p>
            <p><strong>주문수량:</strong> <span th:text="${order.qty}"></span> 개</p>
            <p><strong>납기:</strong> <span th:text="${order.deadline}"></span></p>
        </div>
    </div>

    <!-- ==================== 미수주 상태일 때 ==================== -->
    <div th:if="${order.complete == 0}">
        <div class="col-md-6">
            <h4 class="mb-3 text-success">현재 완제품 재고</h4>
            <div class="alert alert-info">
                <strong th:text="${order.productDto.productName}"></strong>:
                <span th:text="${currentProductStock} + ' 박스'">0 박스</span>
                <span th:if="${currentProductStock < order.qty}" class="badge bg-danger ms-2">출하 불가</span>
                <span th:unless="${currentProductStock < order.qty}" class="badge bg-success ms-2">수주 및 출하 가능</span>
            </div>
        </div>
        <div th:if="${currentProductStock < order.qty}">
            <h4 class="mb-3 text-danger">이 주문을 수주하면 필요한 원자재 현황</h4>
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>재료명</th>
                    <th>필요수량</th>
                    <th>현재재고</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="req : ${requirements}"
                    th:classappend="${!req.sufficient} ? 'table-danger' : 'table-success'">
                    <td th:text="${req.materialName}"></td>
                    <td th:text="${req.requiredQty} + ' ' + ${req.unit}"></td>
                    <td th:text="${req.currentStock} + ' ' + ${req.unit}"></td>
                    <td>
                        <span th:if="${req.sufficient}" class="badge bg-success">충분</span>
                        <span th:unless="${req.sufficient}" class="badge bg-danger">부족</span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ==================== 수주 상태일 때 ==================== -->
    <div th:if="${order.complete == 1}">
        <div class="row">
            <!-- 1. 현재 완제품 재고 -->
            <div class="col-md-6">
                <h4 class="mb-3 text-success">현재 완제품 재고</h4>
                <div class="alert alert-info">
                    <strong th:text="${order.productDto.productName}"></strong>:
                    <span th:text="${currentProductStock} + ' 박스'">0 박스</span>
                    <span th:if="${currentProductStock < order.qty}" class="badge bg-danger ms-2">출하 불가</span>
                    <span th:unless="${currentProductStock < order.qty}" class="badge bg-success ms-2">출하 가능</span>
                </div>
            </div>
        </div>
        <div th:if="${currentProductStock < order.qty}" class="col-md-6">
            <h4 class="mb-3 text-success">남은 생산을 위한 원자재 현황</h4>
            <table class="table table-bordered">
                <thead class="table-light">
                <tr>
                    <th>재료명</th>
                    <th>총 필요수량</th>
                    <th>현재재고</th>
                    <th>남은 필요량</th>
                    <th>상태</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="req : ${remainingRequirements}"
                    th:classappend="${req.remainingQty > 0} ? 'table-danger' : 'table-success'">
                    <td th:text="${req.materialName}"></td>
                    <td th:text="${req.requiredQty} + ' ' + ${req.unit}"></td>
                    <td th:text="${req.currentStock} + ' ' + ${req.unit}"></td>
                    <td th:text="${req.remainingQty} + ' ' + ${req.unit}"></td>
                    <td>
                        <span th:if="${req.remainingQty <= 0}" class="badge bg-success">충분</span>
                        <span th:unless="${req.remainingQty <= 0}" class="badge bg-danger">
                            부족 (<span th:text="${req.remainingQty}"></span>)
                        </span>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- 버튼 영역 -->
    <div class="mt-5">
        <div th:switch="${order.complete}">
            <!-- 미수주 상태 -->
            <div th:case="0">
                <form th:action="@{/order/accept/{id}(id=${order.pr_id})}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-success btn-lg">주문 수주</button>
                </form>
            </div>

            <!-- 수주 완료 상태 -->
            <div th:case="1">
                <form th:action="@{/order/ship/{id}(id=${order.pr_id})}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-primary btn-lg"
                            th:disabled="${currentProductStock < order.qty}">
                        제품 출하
                    </button>
                </form>
                <span th:if="${currentProductStock < order.qty}" class="text-danger ms-3">
                    ※ 재고 부족으로 출하 불가
                </span>
                <form th:action="@{/order/decline/{id}(id=${order.pr_id})}" method="post" style="display:inline;">
                    <button type="submit" class="btn btn-danger btn-lg ms-3">드랍</button>
                </form>
                <a th:href="@{/order}" class="btn btn-secondary btn-lg ms-3">목록</a>
            </div>
        </div>
    </div>

</div>
</body>
</html>
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ì¬ë£Œ ë°œì£¼ í—ˆê°€</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
    <div class="header">
        <div class="header-left">
            <div class="logo">
                <img src="/logo.png" alt="íšŒì‚¬ë¡œê³ " onerror="this.style.display='none'">
            </div>
            <div class="header-text">
                <h1>ì›ì¬ë£Œ ë°œì£¼ í—ˆê°€</h1>
                <p class="subtitle">ìƒì‚°íŒ€ ìš”ì²­ ì›ì¬ë£Œ : ë°œì£¼ í˜„í™©</p>
            </div>
        </div>

        <div class="header-nav">
            <a href="/order.html" class="nav-btn">
                ğŸ“‹ ì™„ì œí’ˆ ìƒì‚° ìš”ì²­
            </a>
            <a href="/material_request.html" class="nav-btn active">
                ğŸ“¦ ì›ì¬ë£Œ ë°œì£¼ í—ˆê°€
            </a>
        </div>

        <div class="status-banner">
            <div class="current-time" id="materialCurrentTime">
                ğŸ• 2025-11-18 10:30:45
            </div>
            <div class="user-status">
                <div class="user-avatar" id="materialUserAvatar">í™</div>
                <div class="user-info-text">
                    <div class="user-name" id="materialUserName">í™ê¸¸ë™</div>
                    <div class="user-role" id="materialUserRole">ê²½ì˜íŒ€ Â· ë§¤ë‹ˆì €</div>
                </div>
            </div>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="tabs">
            <button class="tab active" onclick="MaterialModule.showTab('pending')">
                ë¯¸ìŠ¹ì¸ ë°œì£¼ <span class="tab-count" id="materialPendingCount">0</span>
            </button>
            <button class="tab" onclick="MaterialModule.showTab('all')">
                ì „ì²´ ë°œì£¼ <span class="tab-count" id="materialAllCount">0</span>
            </button>
        </div>

        <div id="materialLoading" class="loading">
            ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤
        </div>

        <div id="materialContent" style="display: none;">
            <table>
                <thead>
                <tr>
                    <th>ë²ˆí˜¸</th>
                    <th>ì›ì¬ë£Œëª…</th>
                    <th>ìš”ì²­ì</th>
                    <th>ìˆ˜ëŸ‰</th>
                    <th>ìš”ì²­ì¼</th>
                    <th>ìƒíƒœ</th>
                    <th>ìŠ¹ì¸ì¼</th>
                    <th>ë¹„ê³ </th>
                    <th>ì‘ì—…</th>
                </tr>
                </thead>
                <tbody id="materialTableBody"></tbody>
            </table>
            <div class="pagination" id="materialPagination"></div>
        </div>

        <div id="materialEmpty" class="empty" style="display: none;">
            ë°œì£¼ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤
        </div>
    </div>
</div>

<div id="materialModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="materialModalTitle">ë°œì£¼ ìŠ¹ì¸</h3>
        </div>
        <div class="modal-body">
            <label for="materialModalNote">ì‚¬ìœ  (ì„ íƒ)</label>
            <textarea id="materialModalNote" rows="4" placeholder="ìŠ¹ì¸ ë˜ëŠ” ë°˜ë ¤ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”"></textarea>
        </div>
        <div class="modal-footer">
            <button class="btn-modal btn-cancel" onclick="MaterialModule.closeModal()">ì·¨ì†Œ</button>
            <button class="btn-modal btn-confirm" id="materialConfirmBtn" onclick="MaterialModule.confirmAction()">í™•ì¸</button>
        </div>
    </div>
</div>

<script>
    const MaterialModule = (function() {
        const API = {
            ALL_REQUESTS: '/pro/material-requests',
            PENDING_REQUESTS: '/pro/material-requests/pending',
            APPROVE: '/pro/material-requests/approve',
            REJECT: '/pro/material-requests/reject'
        };

        let state = {
            currentTab: 'pending',
            currentAction: null, // 1: ìŠ¹ì¸, 2: ë°˜ë ¤
            currentMrId: null,
            currentPage: 1,
            itemsPerPage: 5,
            allData: []
        };

        function init() {
            updateTime();
            setInterval(updateTime, 1000);
            loadUserInfo();
            loadData('pending');
        }

        function updateTime() {
            const now = new Date();
            const formatted = now.getFullYear() + '-' +
                String(now.getMonth() + 1).padStart(2, '0') + '-' +
                String(now.getDate()).padStart(2, '0') + ' ' +
                String(now.getHours()).padStart(2, '0') + ':' +
                String(now.getMinutes()).padStart(2, '0') + ':' +
                String(now.getSeconds()).padStart(2, '0');
            document.getElementById('materialCurrentTime').innerHTML = 'ğŸ• ' + formatted;
        }

        function loadUserInfo() {
            // ë‹¤ë¥¸ íŒ€ì›ì˜ employees ì„¸ì…˜ ì‚¬ìš©
            const employeeInfo = JSON.parse(sessionStorage.getItem('employees') || '{}');

            if (employeeInfo.name) {
                document.getElementById('materialUserName').textContent = employeeInfo.name;
                document.getElementById('materialUserAvatar').textContent = employeeInfo.name.charAt(0);
                const department = employeeInfo.department || 'ê²½ì˜íŒ€';
                const position = employeeInfo.position || 'ë§¤ë‹ˆì €';
                document.getElementById('materialUserRole').textContent = `${department} Â· ${position}`;
            }
        }

        function showTab(tab) {
            state.currentTab = tab;
            state.currentPage = 1;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            loadData(tab);
        }

        async function loadData(tabName) {
            const apiUrl = tabName === 'pending' ? API.PENDING_REQUESTS : API.ALL_REQUESTS;

            try {
                document.getElementById('materialLoading').style.display = 'block';
                document.getElementById('materialContent').style.display = 'none';
                document.getElementById('materialEmpty').style.display = 'none';

                const response = await fetch(apiUrl);

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                state.allData = Array.isArray(data) ? data : [];

                if (state.allData.length === 0) {
                    document.getElementById('materialEmpty').style.display = 'block';
                    document.getElementById('materialContent').style.display = 'none';
                } else {
                    document.getElementById('materialContent').style.display = 'block';
                    renderPage();
                }

                updateTabCounts(tabName, state.allData.length);

            } catch (error) {
                console.error("API ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                document.getElementById('materialLoading').innerHTML = `ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: ${error.message}`;
                document.getElementById('materialLoading').style.display = 'block';
            } finally {
                document.getElementById('materialLoading').style.display = 'none';
            }
        }

        function renderPage() {
            if (!Array.isArray(state.allData)) {
                console.error("renderPage: allData is not an array.");
                return;
            }

            const startIndex = (state.currentPage - 1) * state.itemsPerPage;
            const endIndex = startIndex + state.itemsPerPage;
            const pageData = state.allData.slice(startIndex, endIndex);

            renderTable(pageData);
            renderPagination();
        }

        function renderTable(data) {
            const tbody = document.getElementById('materialTableBody');
            tbody.innerHTML = '';

            data.forEach(item => {
                const row = document.createElement('tr');

                let statusBadge = '';
                if (item.approved === 0) {
                    statusBadge = '<span class="status-badge status-pending">ë¯¸ìŠ¹ì¸</span>';
                } else if (item.approved > 0) {
                    statusBadge = '<span class="status-badge status-approved">ìŠ¹ì¸</span>';
                } else {
                    statusBadge = '<span class="status-badge status-rejected">ë°˜ë ¤</span>';
                }

                let actionButtons = '';
                if (item.approved === 0) {
                    actionButtons = `
                        <button class="btn btn-approve" onclick="MaterialModule.openModal(${item.mrId}, 1)">âœ“ ìŠ¹ì¸</button>
                        <button class="btn btn-reject" onclick="MaterialModule.openModal(${item.mrId}, 2)">âœ• ë°˜ë ¤</button>
                    `;
                } else {
                    const approverText = item.approved > 0 ? (item.approverName || 'ì²˜ë¦¬ì™„ë£Œ') : 'ì²˜ë¦¬ì™„ë£Œ';
                    actionButtons = `<span style="color: #666;">${approverText}</span>`;
                }

                row.innerHTML = `
                    <td><strong>${item.mrId}</strong></td>
                    <td>${item.materialName || '-'}</td>
                    <td>${item.requesterName || '-'}</td>
                    <td><span class="qty-unit">${item.qty} ${item.unit}</span></td>
                    <td>${item.requestDate || '-'}</td>
                    <td>${statusBadge}</td>
                    <td>${item.approvedDate || '-'}</td>
                    <td>${item.note || '-'}</td>
                    <td>${actionButtons}</td>
                `;

                tbody.appendChild(row);
            });
        }

        function renderPagination() {
            const totalPages = Math.ceil(state.allData.length / state.itemsPerPage);
            const pagination = document.getElementById('materialPagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevBtn = document.createElement('button');
            prevBtn.className = 'pagination-btn';
            prevBtn.innerHTML = 'â€¹';
            prevBtn.disabled = state.currentPage === 1;
            prevBtn.onclick = () => goToPage(state.currentPage - 1);
            pagination.appendChild(prevBtn);

            const startPage = Math.max(1, state.currentPage - 2);
            const endPage = Math.min(totalPages, state.currentPage + 2);

            if (startPage > 1) {
                const firstBtn = document.createElement('button');
                firstBtn.className = 'pagination-btn';
                firstBtn.textContent = '1';
                firstBtn.onclick = () => goToPage(1);
                pagination.appendChild(firstBtn);

                if (startPage > 2) {
                    const dots = document.createElement('span');
                    dots.className = 'pagination-info';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = document.createElement('button');
                pageBtn.className = 'pagination-btn' + (i === state.currentPage ? ' active' : '');
                pageBtn.textContent = i;
                pageBtn.onclick = () => goToPage(i);
                pagination.appendChild(pageBtn);
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const dots = document.createElement('span');
                    dots.className = 'pagination-info';
                    dots.textContent = '...';
                    pagination.appendChild(dots);
                }

                const lastBtn = document.createElement('button');
                lastBtn.className = 'pagination-btn';
                lastBtn.textContent = totalPages;
                lastBtn.onclick = () => goToPage(totalPages);
                pagination.appendChild(lastBtn);
            }

            const nextBtn = document.createElement('button');
            nextBtn.className = 'pagination-btn';
            nextBtn.innerHTML = 'â€º';
            nextBtn.disabled = state.currentPage === totalPages;
            nextBtn.onclick = () => goToPage(state.currentPage + 1);
            pagination.appendChild(nextBtn);

            const info = document.createElement('span');
            info.className = 'pagination-info';
            info.textContent = `${state.allData.length}ê°œ ì¤‘ ${((state.currentPage - 1) * state.itemsPerPage) + 1}-${Math.min(state.currentPage * state.itemsPerPage, state.allData.length)}`;
            pagination.appendChild(info);
        }

        function goToPage(page) {
            state.currentPage = page;
            renderPage();
            document.getElementById('materialContent').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function updateTabCounts(currentType, currentCount) {
            const tabs = document.querySelectorAll('.tab');

            if (currentType === 'pending') {
                document.getElementById('materialPendingCount').textContent = currentCount;
                fetch(API.ALL_REQUESTS)
                    .then(response => response.json())
                    .then(data => {
                        const count = Array.isArray(data) ? data.length : 0;
                        document.getElementById('materialAllCount').textContent = count;
                    })
                    .catch(error => console.error("ì „ì²´ ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error));
            } else {
                document.getElementById('materialAllCount').textContent = currentCount;
                fetch(API.PENDING_REQUESTS)
                    .then(response => response.json())
                    .then(data => {
                        const count = Array.isArray(data) ? data.length : 0;
                        document.getElementById('materialPendingCount').textContent = count;
                    })
                    .catch(error => console.error("ë¯¸ìŠ¹ì¸ ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:", error));
            }
        }

        function openModal(mrId, action) {
            state.currentMrId = mrId;
            state.currentAction = action;

            const modal = document.getElementById('materialModal');
            const modalTitle = document.getElementById('materialModalTitle');
            const confirmBtn = document.getElementById('materialConfirmBtn');

            if (action === 1) {
                modalTitle.textContent = 'âœ“ ë°œì£¼ ìŠ¹ì¸';
                confirmBtn.textContent = 'ìŠ¹ì¸';
                confirmBtn.className = 'btn-modal btn-confirm';
            } else {
                modalTitle.textContent = 'âœ• ë°œì£¼ ë°˜ë ¤';
                confirmBtn.textContent = 'ë°˜ë ¤';
                confirmBtn.className = 'btn-modal btn-confirm reject';
            }

            document.getElementById('materialModalNote').value = '';
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('materialModal').style.display = 'none';
        }

        function confirmAction() {
            const note = document.getElementById('materialModalNote').value.trim();
            const isApprove = state.currentAction === 1;

            // ë‹¤ë¥¸ íŒ€ì›ì˜ employees ì„¸ì…˜ì—ì„œ ìŠ¹ì¸ì ID ê°€ì ¸ì˜¤ê¸°
            const employeeInfo = JSON.parse(sessionStorage.getItem('employees') || '{}');
            const approvedBy = employeeInfo.employeeId || 200; // ê¸°ë³¸ê°’ 200

            if (!approvedBy) {
                alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }

            const apiUrl = isApprove ? API.APPROVE : API.REJECT;

            const data = {
                mrId: state.currentMrId,
                approvedBy: approvedBy,
                note: note || null
            };

            fetch(apiUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (!response.ok) {
                     throw new Error('ì²˜ë¦¬ API ì„œë²„ ì˜¤ë¥˜');
                }
                return response.json();
            })
            .then(result => {
                closeModal();
                alert(isApprove ? 'ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë°˜ë ¤ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadData(state.currentTab);
            })
            .catch(error => {
                console.error('Error:', error);
                alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            });
        }

        window.onclick = function(event) {
            const modal = document.getElementById('materialModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        return {
            init,
            showTab,
            openModal,
            closeModal,
            confirmAction
        };
    })();

    window.onload = MaterialModule.init;
</script>
</body>
</html>